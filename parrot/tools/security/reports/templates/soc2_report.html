{% extends "base.html" %}
{% block title %}SOC2 Compliance Report{% endblock %}

{% block content %}
<h1>SOC2 Type II Compliance Report</h1>

<div class="summary-box">
    <h2>Executive Summary</h2>
    <div class="summary-grid">
        <div class="summary-stat">
            <span class="value">{{ report.total_findings }}</span>
            <span class="label">Total Findings</span>
        </div>
        <div class="summary-stat">
            <span class="value">{{ coverage.coverage_pct | round(1) }}%</span>
            <span class="label">Coverage</span>
        </div>
        <div class="summary-stat">
            <span class="value">{{ coverage.checked_controls }}</span>
            <span class="label">Controls Checked</span>
        </div>
        <div class="summary-stat">
            <span class="value">{{ coverage.passed_controls }}</span>
            <span class="label">Controls Passed</span>
        </div>
    </div>
    <div style="margin-top: 20px;">
        <p><strong>Pass Rate:</strong> {{ coverage.pass_pct | round(1) }}%</p>
        <div class="coverage-bar">
            <div class="fill" style="width: {{ coverage.pass_pct }}%;"></div>
        </div>
    </div>
</div>

<div class="toc">
    <h3>Table of Contents</h3>
    <ul>
        <li><a href="#severity-breakdown">Severity Breakdown</a></li>
        <li><a href="#trust-service-criteria">Trust Service Criteria</a></li>
        {% if include_evidence %}
        <li><a href="#evidence-details">Evidence Details</a></li>
        {% endif %}
    </ul>
</div>

<h2 id="severity-breakdown">Severity Breakdown</h2>
<table>
    <tr>
        <th>Severity</th>
        <th>Count</th>
        <th>Percentage</th>
    </tr>
    {% for severity, count in severity_breakdown.items() %}
    <tr>
        <td><span class="severity-badge {{ severity | lower }}">{{ severity }}</span></td>
        <td>{{ count }}</td>
        <td>{{ ((count / report.total_findings) * 100) | round(1) if report.total_findings > 0 else 0 }}%</td>
    </tr>
    {% endfor %}
</table>

<h2 id="trust-service-criteria">Trust Service Criteria</h2>

{% set category_names = {
    'CC1': 'Control Environment',
    'CC2': 'Communication and Information',
    'CC3': 'Risk Assessment',
    'CC4': 'Monitoring Activities',
    'CC5': 'Control Activities',
    'CC6': 'Logical and Physical Access Controls',
    'CC7': 'System Operations',
    'CC8': 'Change Management',
    'CC9': 'Risk Mitigation'
} %}

{% for category_prefix in ['CC1', 'CC2', 'CC3', 'CC4', 'CC5', 'CC6', 'CC7', 'CC8', 'CC9'] %}
{% set category_controls = controls_by_category.get(category_prefix, []) %}
{% if category_controls %}
<div class="control-section">
    <h3>{{ category_prefix }}: {{ category_names.get(category_prefix, 'Controls') }}</h3>
    <table>
        <tr>
            <th>Control ID</th>
            <th>Control Name</th>
            <th>Status</th>
            <th>Findings</th>
        </tr>
        {% for control in category_controls %}
        <tr>
            <td><strong>{{ control.id }}</strong></td>
            <td>{{ control.name }}</td>
            <td class="status-{{ control.status }}">{{ control.status | upper }}</td>
            <td>{{ control.finding_count }}</td>
        </tr>
        {% endfor %}
    </table>
</div>
{% endif %}
{% endfor %}

{% if include_evidence and findings %}
<h2 id="evidence-details">Evidence Details</h2>
<p>The following findings provide evidence of security control effectiveness or gaps.</p>

{% for finding in findings %}
<div class="finding-card">
    <h4>
        <span class="severity-badge {{ finding.severity.value | lower }}">{{ finding.severity.value }}</span>
        {{ finding.title }}
    </h4>
    <div class="meta">
        <div><strong>ID:</strong> {{ finding.id or 'N/A' }}</div>
        <div><strong>Source:</strong> {{ finding.source.value | upper }}</div>
        <div><strong>Check ID:</strong> {{ finding.check_id or 'N/A' }}</div>
        <div><strong>Resource:</strong> {{ finding.resource or 'N/A' }}</div>
    </div>
    {% if finding.description %}
    <p style="margin-top: 15px;"><strong>Description:</strong> {{ finding.description }}</p>
    {% endif %}
    {% if finding.remediation %}
    <div class="remediation">
        <strong>Remediation:</strong> {{ finding.remediation }}
    </div>
    {% endif %}
</div>
{% endfor %}
{% endif %}

{% endblock %}
