{% extends "base.html" %}
{% block title %}PCI-DSS Compliance Report{% endblock %}

{% block content %}
<h1>PCI-DSS v4.0 Compliance Report</h1>

<div class="summary-box">
    <h2>Executive Summary</h2>
    <div class="summary-grid">
        <div class="summary-stat">
            <span class="value">{{ report.total_findings }}</span>
            <span class="label">Total Findings</span>
        </div>
        <div class="summary-stat">
            <span class="value">{{ coverage.coverage_pct | round(1) }}%</span>
            <span class="label">Coverage</span>
        </div>
        <div class="summary-stat">
            <span class="value">{{ coverage.checked_controls }}</span>
            <span class="label">Requirements Checked</span>
        </div>
        <div class="summary-stat">
            <span class="value">{{ coverage.passed_controls }}</span>
            <span class="label">Requirements Passed</span>
        </div>
    </div>
    <div style="margin-top: 20px;">
        <p><strong>Compliance Rate:</strong> {{ coverage.pass_pct | round(1) }}%</p>
        <div class="coverage-bar">
            <div class="fill" style="width: {{ coverage.pass_pct }}%;"></div>
        </div>
    </div>
</div>

<div class="toc">
    <h3>Table of Contents</h3>
    <ul>
        <li><a href="#severity-breakdown">Severity Breakdown</a></li>
        <li><a href="#pci-requirements">PCI-DSS Requirements</a></li>
        {% if include_evidence %}
        <li><a href="#evidence-details">Evidence Details</a></li>
        {% endif %}
    </ul>
</div>

<h2 id="severity-breakdown">Severity Breakdown</h2>
<table>
    <tr>
        <th>Severity</th>
        <th>Count</th>
        <th>Percentage</th>
    </tr>
    {% for severity, count in severity_breakdown.items() %}
    <tr>
        <td><span class="severity-badge {{ severity | lower }}">{{ severity }}</span></td>
        <td>{{ count }}</td>
        <td>{{ ((count / report.total_findings) * 100) | round(1) if report.total_findings > 0 else 0 }}%</td>
    </tr>
    {% endfor %}
</table>

<h2 id="pci-requirements">PCI-DSS Requirements</h2>

{% set requirement_names = {
    'network_security': 'Requirement 1 - Network Security Controls',
    'secure_configuration': 'Requirement 2 - Secure Configuration',
    'data_protection': 'Requirement 3 - Protect Stored Account Data',
    'transmission_security': 'Requirement 4 - Strong Cryptography During Transmission',
    'malware_protection': 'Requirement 5 - Protect from Malicious Software',
    'secure_development': 'Requirement 6 - Develop Secure Systems',
    'vulnerability_management': 'Requirement 6 - Vulnerability Management',
    'application_security': 'Requirement 6 - Application Security',
    'access_control': 'Requirement 7 - Restrict Access',
    'authentication': 'Requirement 8 - Identify and Authenticate Users',
    'physical_security': 'Requirement 9 - Physical Access',
    'logging_monitoring': 'Requirement 10 - Log and Monitor',
    'security_testing': 'Requirement 11 - Test Security',
    'security_policy': 'Requirement 12 - Security Policies',
    'incident_response': 'Requirement 12 - Incident Response'
} %}

{% for category, category_name in requirement_names.items() %}
{% set category_controls = controls_by_category.get(category, []) %}
{% if category_controls %}
<div class="control-section">
    <h3>{{ category_name }}</h3>
    <table>
        <tr>
            <th>Requirement</th>
            <th>Description</th>
            <th>Status</th>
            <th>Findings</th>
        </tr>
        {% for control in category_controls %}
        <tr>
            <td><strong>{{ control.id }}</strong></td>
            <td>{{ control.name }}</td>
            <td class="status-{{ control.status }}">{{ control.status | upper }}</td>
            <td>{{ control.finding_count }}</td>
        </tr>
        {% endfor %}
    </table>
</div>
{% endif %}
{% endfor %}

{% if include_evidence and findings %}
<h2 id="evidence-details">Evidence Details</h2>
<p>The following findings provide evidence of PCI-DSS control effectiveness or gaps.</p>

{% for finding in findings %}
<div class="finding-card">
    <h4>
        <span class="severity-badge {{ finding.severity.value | lower }}">{{ finding.severity.value }}</span>
        {{ finding.title }}
    </h4>
    <div class="meta">
        <div><strong>ID:</strong> {{ finding.id or 'N/A' }}</div>
        <div><strong>Source:</strong> {{ finding.source.value | upper }}</div>
        <div><strong>Check ID:</strong> {{ finding.check_id or 'N/A' }}</div>
        <div><strong>Resource:</strong> {{ finding.resource or 'N/A' }}</div>
    </div>
    {% if finding.description %}
    <p style="margin-top: 15px;"><strong>Description:</strong> {{ finding.description }}</p>
    {% endif %}
    {% if finding.remediation %}
    <div class="remediation">
        <strong>Remediation:</strong> {{ finding.remediation }}
    </div>
    {% endif %}
</div>
{% endfor %}
{% endif %}

{% endblock %}
